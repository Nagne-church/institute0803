<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>그리스도의 구속 사역과 중보자 되심</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pretendard@1.3.9/dist/web/static/pretendard.min.css" />
    <style>
        body {
            font-family: 'Pretendard', sans-serif;
            background-color: #f0f2f5;
        }
        .infographic-card {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            margin-bottom: 2rem;
            overflow: hidden;
            border-left-width: 8px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .infographic-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
        }
        .icon-bg {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .icon-bg svg {
            width: 32px;
            height: 32px;
        }
        .ask-question-btn {
            background-color: #4f46e5;
            color: white;
            font-weight: 600;
            padding: 10px 20px;
            border-radius: 8px;
            transition: background-color 0.3s ease;
            margin-top: 1.5rem;
            cursor: pointer;
        }
        .ask-question-btn:hover {
            background-color: #4338ca;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0s 0.3s;
        }
        .modal-container {
            background-color: white;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
            transition: opacity 0.3s ease;
        }
        .modal-overlay.active .modal-container {
            transform: scale(1);
        }
        .modal-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-body {
            padding: 1.5rem;
            overflow-y: auto;
            flex-grow: 1;
        }
        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid #e5e7eb;
        }
        .chat-bubble {
            padding: 12px 16px;
            border-radius: 18px;
            margin-bottom: 12px;
            max-width: 85%;
            word-wrap: break-word;
        }
        .user-bubble {
            background-color: #eef2ff;
            color: #4338ca;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }
        .ai-bubble {
            background-color: #f3f4f6;
            color: #1f2937;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }
        .typing-indicator span {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #9ca3af;
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }
    </style>
</head>
<body class="p-4 sm:p-6 md:p-10">
    <main class="max-w-4xl mx-auto">
        <header class="text-center mb-12">
            <h1 class="text-4xl sm:text-5xl font-extrabold text-gray-800 mb-3">그리스도의 구속 사역과 중보자 되심</h1>
            <p class="text-lg sm:text-xl text-gray-600">참 하나님이시며 참 사람이신 예수 그리스도께서 우리를 위해 행하신 구속의 은혜와 유일한 중보자로서의 역할에 대한 해설</p>
        </header>

        <section id="chapter1" class="infographic-card" style="border-color: #3b82f6;">
            <div class="p-6 sm:p-8 flex items-start gap-6">
                <div class="icon-bg" style="background-color: #dbeafe;">
                    <svg style="color: #3b82f6;" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12Z" />
                    </svg>
                </div>
                <div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">제 1장: 구원의 동기: 하나님의 자비로운 사랑</h2>
                    <div class="space-y-4 text-gray-700 leading-relaxed">
                        <p>우리를 향한 구원의 시작은 전적으로 하나님의 자유로운 사랑과 자비에서 비롯되었습니다. 우리가 아직 죄인 되었을 때, 심지어 하나님과 원수 관계에 있었을 때, 하나님께서는 그의 독생자 예수를 우리에게 보내주시기로 결정하셨습니다. 이 결정에는 우리의 어떠한 공로나 자격도 개입되지 않았습니다.</p>
                        <h3 class="text-lg font-semibold mt-6 mb-2">하나님의 주권적 은혜</h3>
                        <p>하나님께서 우리를 사랑하시기로 작정하신 것은 그의 선하시고 기쁘신 뜻에 따른 것입니다. 이는 마치 부모가 자녀를 사랑하는 것과 비견될 수 없으며, 창조주가 피조물, 그것도 반역한 원수를 향해 베푸시는 측량할 수 없는 긍휼의 표현입니다. 그리스도를 보내신 것은 이처럼 값없이 주어지는 하나님의 친절과 자비의 가장 위대한 확증입니다.</p>
                    </div>
                    <button class="ask-question-btn">이 장에 대해 질문하기</button>
                </div>
            </div>
        </section>

        <section id="chapter2" class="infographic-card" style="border-color: #8b5cf6;">
            <div class="p-6 sm:p-8 flex items-start gap-6">
                <div class="icon-bg" style="background-color: #ede9fe;">
                    <svg style="color: #8b5cf6;" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 10.5V6.75a4.5 4.5 0 0 0-9 0v3.75M3.75 21.75h16.5a1.5 1.5 0 0 0 1.5-1.5v-6a1.5 1.5 0 0 0-1.5-1.5H3.75a1.5 1.5 0 0 0-1.5 1.5v6a1.5 1.5 0 0 0 1.5 1.5Z" />
                    </svg>
                </div>
                <div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">제 2장: 구속의 목적: 우리를 자유케 하심</h2>
                    <div class="space-y-4 text-gray-700 leading-relaxed">
                        <p>그리스도께서 이 땅에 오신 목적은 우리를 얽매고 있던 모든 속박으로부터 풀어주시기 위함입니다. '구속(Redemption)'이란 단어 자체가 '값을 치르고 사서 자유롭게 하다'는 의미를 가집니다. 그리스도는 자신의 생명을 값으로 치르시고 우리를 해방시키셨습니다.</p>
                        <h3 class="text-lg font-semibold mt-6 mb-2">우리가 해방된 네 가지 속박</h3>
                        <ul class="list-disc list-inside space-y-2 pl-2">
                            <li><strong>마귀의 압제:</strong> 사탄의 권세 아래에서 종노릇하던 우리를 해방시키셨습니다.</li>
                            <li><strong>죄의 멍에:</strong> 율법의 정죄와 죄책감으로부터 우리를 자유롭게 하셨습니다.</li>
                            <li><strong>죽음의 공포:</strong> 영혼과 육신의 죽음이라는 피할 수 없는 운명에서 우리를 건져내셨습니다.</li>
                            <li><strong>영원한 형벌:</strong> 죄의 결과인 지옥의 심판으로부터 우리를 구원하셨습니다.</li>
                        </ul>
                    </div>
                    <button class="ask-question-btn">이 장에 대해 질문하기</button>
                </div>
            </div>
        </section>

        <section id="chapter3" class="infographic-card" style="border-color: #ec4899;">
            <div class="p-6 sm:p-8 flex items-start gap-6">
                <div class="icon-bg" style="background-color: #fce7f3;">
                    <svg style="color: #ec4899;" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z" />
                    </svg>
                </div>
                <div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">제 3장: 인성 취득의 신비와 유익</h2>
                    <div class="space-y-4 text-gray-700 leading-relaxed">
                        <p>성자 하나님께서 우리의 육체를 입고 참 사람이 되신 것, 즉 '성육신'은 구속 사역의 핵심적인 신비입니다. 이는 신성이 인성으로 변하거나 혼합된 것이 아니라, 한 인격 안에 완전한 신성과 완전한 인성이 연합하여 존재하심을 의미합니다.</p>
                        
                        <h3 class="text-lg font-semibold mt-6 mb-2">인성을 취하심으로 얻게 된 유익</h3>
                        <ul class="list-disc list-inside space-y-3 pl-2">
                            <li><strong>하나님께 담대히 나아감:</strong> 그리스도께서 우리의 연약함을 친히 겪으셨기에, 우리는 그분을 의지하여 죄인임에도 불구하고 은혜의 보좌 앞에 담대히 나아갈 수 있게 되었습니다.</li>
                            <li><strong>복된 교환 (Happy Exchange):</strong> 그리스도께서 우리의 죄와 연약함, 저주를 모두 가져가시고, 자신의 의와 생명, 거룩함을 우리에게 선물로 주셨습니다.</li>
                            <li><strong>하나님의 상속자 됨:</strong> 본래 지옥의 상속자였던 우리가 그리스도로 말미암아 하나님의 자녀가 되고, 그리스도와 함께 천국의 공동 상속자가 되는 영광을 얻었습니다.</li>
                        </ul>
                    </div>
                    <button class="ask-question-btn">이 장에 대해 질문하기</button>
                </div>
            </div>
        </section>

        <section id="chapter4" class="infographic-card" style="border-color: #10b981;">
            <div class="p-6 sm:p-8 flex items-start gap-6">
                <div class="icon-bg" style="background-color: #d1fae5;">
                    <svg style="color: #10b981;" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 10.5V6.75a4.5 4.5 0 0 0-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 0 0 2.25-2.25v-6.75a2.25 2.25 0 0 0-2.25-2.25H6.75a2.25 2.25 0 0 0-2.25 2.25v6.75a2.25 2.25 0 0 0 2.25 2.25Z" />
                    </svg>
                </div>
                <div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">제 4장: 유일한 중보자, 사람이신 그리스도</h2>
                    <div class="space-y-4 text-gray-700 leading-relaxed">
                        <p>성경은 분명하게 "하나님과 사람 사이의 중보자도 한 분이시니 곧 사람이신 그리스도 예수라"(딤전 2:5)고 증언합니다. 여기서 '사람'이심을 강조하는 이유는 우리의 연약한 믿음을 돕기 위함입니다. 보이지 않는 하나님과 죄인인 우리 사이를 연결하기 위해, 우리와 같은 성정을 지니신 '사람' 중보자가 필요했습니다.</p>
                        
                        <h3 class="text-lg font-semibold mt-6 mb-2">중보자의 자격</h3>
                        <p>그리스도께서 우리의 중보자가 되실 수 있는 이유는 그분이 완전한 하나님이시면서 동시에 완전한 사람이시기 때문입니다. 만약 그분의 신성이나 인성 중 하나라도 부정된다면, 구속의 진리는 훼손되고 우리의 구원은 불완전해집니다.</p>
                        <ul class="list-disc list-inside space-y-2 pl-2">
                           <li><strong>천사들의 머리:</strong> 만물의 창조주이신 그리스도는 천사들보다 뛰어나시며 그들의 경배를 받으시는 분입니다. 천사조차도 그리스도를 통해 하나님을 섬긴다면, 죄인인 우리는 더욱 그리스도의 중보가 절실합니다.</li>
                           <li><strong>신성과 인성의 연합:</strong> 그리스도의 한 인격 안에 있는 신성과 인성의 신비로운 연합은, 그분이 하나님과 인간 사이의 완벽한 다리가 되게 합니다. 이 진리를 굳게 붙드는 것이 우리 믿음의 핵심입니다.</li>
                        </ul>
                    </div>
                    <button class="ask-question-btn">이 장에 대해 질문하기</button>
                </div>
            </div>
        </section>
    </main>

    <div id="qa-modal" class="modal-overlay">
        <div class="modal-container">
            <header class="modal-header">
                <h2 id="modal-title" class="text-xl font-bold text-gray-800">질문하기</h2>
                <button id="close-modal-btn" class="text-gray-500 hover:text-gray-800">&times;</button>
            </header>
            <main id="modal-body" class="modal-body">
                <div id="chat-window" class="flex flex-col h-full space-y-4">
                    </div>
            </main>
            <footer class="modal-footer">
                <form id="qa-form" class="flex items-center gap-2">
                    <input id="question-input" type="text" class="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="여기에 질문을 입력하세요..." autocomplete="off">
                    <button type="submit" class="bg-indigo-600 text-white p-2 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M5 10l7-7m0 0l7 7m-7-7v18" />
                        </svg>
                    </button>
                </form>
            </footer>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const modal = document.getElementById('qa-modal');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const qaForm = document.getElementById('qa-form');
            const questionInput = document.getElementById('question-input');
            const chatWindow = document.getElementById('chat-window');
            const modalTitle = document.getElementById('modal-title');
            
            let currentChapterTitle = '';
            let currentChapterContext = '';

            document.querySelectorAll('.ask-question-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const card = e.target.closest('.infographic-card');
                    currentChapterTitle = card.querySelector('h2').innerText;
                    
                    const contentDiv = card.querySelector('div > div');
                    currentChapterContext = Array.from(contentDiv.children)
                        .map(el => el.innerText.trim())
                        .filter(text => text)
                        .join('\n\n');

                    modalTitle.textContent = `${currentChapterTitle}`;
                    chatWindow.innerHTML = `
                        <div class="chat-bubble ai-bubble">
                            안녕하세요! <strong>${currentChapterTitle}</strong>에 대해 무엇이든 물어보세요.
                        </div>
                    `;
                    openModal();
                });
            });

            function openModal() {
                modal.classList.add('active');
                document.body.style.overflow = 'hidden';
                setTimeout(() => questionInput.focus(), 300);
            }

            function closeModal() {
                modal.classList.remove('active');
                document.body.style.overflow = '';
            }

            closeModalBtn.addEventListener('click', closeModal);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal();
                }
            });

            qaForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const userQuestion = questionInput.value.trim();
                if (!userQuestion) return;

                appendMessage(userQuestion, 'user');
                questionInput.value = '';
                showTypingIndicator();

                const finalPrompt = `
                    당신은 [콘텐츠 주제]에 대해 설명하는 전문 AI 어시스턴트입니다. 아래에 명시된 두 가지 규칙의 우선순위를 반드시 지켜서 사용자의 질문에 답변해 주세요.

                    [규칙 1: 주어진 자료 우선의 원칙]
                    - 최우선적으로, 아래에 제공되는 "[강의 노트 내용]"에 근거하여 답변을 생성해야 합니다.
                    - 자료에 명시된 사실과 논리를 바탕으로 질문에 직접적으로 그리고 자연스럽게 답해주세요.

                    [규칙 2: 지식 확장 및 보충의 원칙]
                    - 만약 "[강의 노트 내용]"만으로 답변하기에 정보가 불충분하거나 관련 내용이 없을 경우에는, 당신의 전통적 개혁신학의 전문 지식을 활용하여 답변을 보충할 수 있습니다.(반드시 전통 개혁신학에 근거해야 합니다.)
                    - 이 경우, 보충된 내용이 원래 자료에 없었음을 명확히 하기 위해 "보충 설명을 드리자면..." 과 같이 서술을 시작해주세요.

                    ---
                    [강의 노트 제목]: ${currentChapterTitle}
                    ---
                    [강의 노트 내용]:
                    ${currentChapterContext}
                    ---
                    [사용자 질문]:
                    ${userQuestion}
                `;

                try {
                    const response = await fetch('/api/ask-gemini', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ prompt: finalPrompt })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    
                    // Safe navigation to extract text
                    const aiResponse = data?.candidates?.[0]?.content?.parts?.[0]?.text;

                    if (!aiResponse) {
                        throw new Error("Invalid response structure from API.");
                    }
                    
                    removeTypingIndicator();
                    appendMessage(aiResponse, 'ai');

                } catch (error) {
                    console.error('Error fetching AI response:', error);
                    removeTypingIndicator();
                    appendMessage('죄송합니다. 답변을 가져오는 중 오류가 발생했습니다. 잠시 후 다시 시도해 주세요.', 'ai');
                }
            });

            function appendMessage(text, sender) {
                const messageDiv = document.createElement('div');
                const bubbleClass = sender === 'user' ? 'user-bubble' : 'ai-bubble';
                messageDiv.className = `chat-bubble ${bubbleClass} flex flex-col`;
                
                // Simple markdown to HTML conversion
                let htmlText = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                htmlText = htmlText.replace(/\n/g, '<br>');

                messageDiv.innerHTML = htmlText;
                chatWindow.appendChild(messageDiv);
                chatWindow.scrollTop = chatWindow.scrollHeight;
            }
            
            function showTypingIndicator() {
                const typingDiv = document.createElement('div');
                typingDiv.id = 'typing-indicator';
                typingDiv.className = 'chat-bubble ai-bubble typing-indicator';
                typingDiv.innerHTML = '<span></span><span></span><span></span>';
                chatWindow.appendChild(typingDiv);
                chatWindow.scrollTop = chatWindow.scrollHeight;
            }

            function removeTypingIndicator() {
                const indicator = document.getElementById('typing-indicator');
                if (indicator) {
                    indicator.remove();
                }
            }
        });
    </script>
</body>
</html>
